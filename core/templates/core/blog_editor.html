{% extends 'base.html' %}

{% block title %}{% if post %}Edit Post{% else %}New Post{% endif %}{% endblock %}

{% block content %}
<section>
    <div style="margin-bottom: 2rem;">
        <a href="{% url 'blog_index' %}" style="color: var(--secondary-text); text-decoration: none;">&larr; back to blog</a>
    </div>

    <!-- Title Input -->
    <input type="text" id="post-title" 
           value="{{ post.title|default:'' }}"
           placeholder="Post title..."
           style="width: 100%; font-size: 2rem; font-weight: bold; border: none; background: transparent; color: var(--text-color); margin-bottom: 2rem; outline: none; font-family: inherit;">
    
    <!-- Quill Editor Container -->
    <div id="editor-container" style="border-radius: 8px;">
        <div id="editor" style="min-height: 500px;">
            {{ post.content_html|default:"<p><br></p>"|safe }}
        </div>
    </div>
    
    <!-- Post Options Panel -->
    <div id="post-options-panel" style="margin-top: 2rem; background: #f8f9fa; border-radius: 8px; overflow: hidden;">
        <button type="button" id="post-options-toggle" style="width: 100%; padding: 1rem; background: #e9ecef; border: none; cursor: pointer; font-weight: 600; text-align: left; display: flex; justify-content: space-between; align-items: center;">
            <span>üìù Post Options</span>
            <span id="post-options-arrow">‚ñº</span>
        </button>
        <div id="post-options-content" style="padding: 1.5rem; display: none;">
            <!-- Post Status -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Post Status</label>
                <select id="post-status" style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; min-width: 150px;">
                    <option value="draft" {% if not post.published %}selected{% endif %}>üìù Draft</option>
                    <option value="published" {% if post.published %}selected{% endif %}>‚úÖ Published</option>
                </select>
            </div>
            
            <!-- Slug -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">URL Slug</label>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: #666;">/blog/</span>
                    <input type="text" id="post-slug" value="{{ post.slug|default:'' }}" placeholder="your-post-url" 
                           style="flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>
            
            <!-- Excerpt / Description -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">
                    Description / Excerpt <span id="excerpt-count" style="font-weight: normal; color: #666;">(0/300)</span>
                </label>
                <textarea id="post-excerpt" maxlength="300" rows="3"
                          placeholder="Short preview text for blog listings... (auto-generated from post if empty)"
                          style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; resize: vertical; box-sizing: border-box;">{{ post.excerpt|default:'' }}</textarea>
                <button type="button" id="auto-excerpt" style="margin-top: 0.5rem; padding: 0.4rem 0.8rem; background: #e9ecef; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                    üîÑ Auto-generate from post
                </button>
            </div>
            
            <!-- Featured Image -->
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Featured Image</label>
                
                <!-- Image Preview -->
                <div id="featured-image-preview" style="margin-bottom: 1rem; display: {{ post.featured_image|yesno:'block,none,none' }};">
                    <img id="featured-image-img" src="{{ post.featured_image|default:'' }}" alt="Featured" 
                         style="max-width: 200px; max-height: 133px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd;">
                </div>
                
                <!-- Image Selection -->
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                    <button type="button" id="select-from-post" style="padding: 0.5rem 1rem; background: #e9ecef; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        üì∑ Select from post images
                    </button>
                    <label style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        üì§ Upload new
                        <input type="file" id="upload-featured" accept="image/*" style="display: none;">
                    </label>
                    <button type="button" id="clear-featured" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        ‚úï Remove
                    </button>
                </div>
                
                <!-- Post Images Grid (hidden by default) -->
                <div id="post-images-grid" style="display: none; gap: 0.5rem; flex-wrap: wrap; padding: 1rem; background: #fff; border-radius: 8px; border: 1px solid #ddd; margin-top: 0.5rem;">
                    <p style="color: #666; margin: 0; font-size: 0.9rem;">Click an image to select it as featured:</p>
                    <div id="post-images-container" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;"></div>
                </div>
                
                <!-- URL input -->
                <input type="url" id="featured-image-url" value="{{ post.featured_image|default:'' }}" 
                       placeholder="Or paste image URL..."
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; margin-top: 0.5rem; box-sizing: border-box;">
            </div>
        </div>
    </div>
    
    <!-- SEO Settings Panel -->
    <div id="seo-panel" style="margin-top: 1rem; background: #f8f9fa; border-radius: 8px; overflow: hidden;">
        <button type="button" id="seo-toggle" style="width: 100%; padding: 1rem; background: #e9ecef; border: none; cursor: pointer; font-weight: 600; text-align: left; display: flex; justify-content: space-between; align-items: center;">
            <span>üîç SEO Settings</span>
            <span id="seo-arrow">‚ñº</span>
        </button>
        <div id="seo-content" style="padding: 1.5rem; display: none;">
            <!-- Meta Title -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">
                    Meta Title <span id="meta-title-count" style="font-weight: normal; color: #666;">(0/60)</span>
                </label>
                <input type="text" id="meta-title" value="{{ post.meta_title|default:'' }}" maxlength="70"
                       placeholder="SEO-optimized title for search engines..."
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
            </div>
            
            <!-- Meta Description -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">
                    Meta Description <span id="meta-desc-count" style="font-weight: normal; color: #666;">(0/160)</span>
                </label>
                <textarea id="meta-description" maxlength="160" rows="3"
                          placeholder="Brief description for search results..."
                          style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; resize: vertical; box-sizing: border-box;">{{ post.meta_description|default:'' }}</textarea>
            </div>
            
            <!-- OG Image -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Social Share Image (OG Image)</label>
                <input type="url" id="og-image" value="{{ post.og_image|default:'' }}" 
                       placeholder="https://example.com/image.jpg"
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                <small style="color: #666;">Recommended: 1200x630 pixels. Uses Featured Image if empty.</small>
            </div>
            
            <!-- Search Preview -->
            <div style="margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #ddd;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.75rem; color: #333;">üîç Google Preview</label>
                <div style="font-family: Arial, sans-serif;">
                    <div id="preview-title" style="color: #1a0dab; font-size: 18px; margin-bottom: 2px;">{% if post.meta_title %}{{ post.meta_title }}{% elif post.title %}{{ post.title }}{% else %}Post Title{% endif %}</div>
                    <div id="preview-url" style="color: #006621; font-size: 14px; margin-bottom: 2px;">example.com ‚Ä∫ blog ‚Ä∫ <span id="preview-slug">{{ post.slug|default:'your-post' }}</span></div>
                    <div id="preview-desc" style="color: #545454; font-size: 13px; line-height: 1.4;">{{ post.meta_description|default:'Your meta description will appear here...' }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SEO Report Panel -->
    <div id="seo-report-panel" style="margin-top: 1rem; background: #f8f9fa; border-radius: 8px; overflow: hidden;">
        <button type="button" id="seo-report-toggle" style="width: 100%; padding: 1rem; background: #e9ecef; border: none; cursor: pointer; font-weight: 600; text-align: left; display: flex; justify-content: space-between; align-items: center;">
            <span>üìä SEO Report (AI-Powered)</span>
            <span id="seo-report-arrow">‚ñº</span>
        </button>
        <div id="seo-report-content" style="padding: 1.5rem; display: none;">
            <p style="margin-bottom: 1.25rem; color: #666; font-size: 0.9rem;">
                –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ç—å—é —Å –ø–æ–º–æ—â—å—é AI –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö SEO-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –ø–æ–∑–∏—Ü–∏–π –≤ Google –∏ –Ø–Ω–¥–µ–∫—Å.
            </p>
            
            <!-- Keyword Inputs -->
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333; font-size: 0.9rem;">
                    –û—Å–Ω–æ–≤–Ω–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ <span style="font-weight: normal; color: #999;">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                </label>
                <input type="text" id="seo-main-keyword" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ –∞–∫—Ü–∏–∏"
                       style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 0.9rem;">
            </div>
            
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333; font-size: 0.9rem;">
                    LSI –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ <span style="font-weight: normal; color: #999;">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</span>
                </label>
                <input type="text" id="seo-lsi-keywords" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ñ–æ–Ω–¥–æ–≤—ã–π —Ä—ã–Ω–æ–∫, –¥–∏–≤–∏–¥–µ–Ω–¥—ã, –ø–æ—Ä—Ç—Ñ–µ–ª—å"
                       style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 0.9rem;">
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap;">
                <select id="seo-model-select" style="padding: 0.5rem 0.75rem; border: 1px solid #ccc; border-radius: 6px; background: white; font-size: 0.9rem; cursor: pointer;">
                    <option value="gemini-2.0-flash" selected>Gemini 2.0 Flash (Default)</option>
                    <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
                    <option value="gemini-3-pro-preview">Gemini 3 Pro Preview</option>
                    <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash</option>
                    <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option>
                </select>
                <button type="button" id="btn-analyze-seo" style="padding: 0.6rem 1.2rem; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: opacity 0.2s;">
                    üîç Analyze SEO
                </button>
                <button type="button" id="btn-reanalyze-seo" style="padding: 0.6rem 1.2rem; background: transparent; color: #333; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
                    üîÑ Re-analyze
                </button>
            </div>
            
            <!-- No Slug Warning (shown/hidden by JS) -->
            <div id="seo-no-slug-warning" style="display: none; padding: 0.75rem; background: #fff3cd; border-radius: 6px; margin-bottom: 1rem; color: #856404; font-size: 0.9rem;">
                ‚ö†Ô∏è Please save the post first (to create a URL slug) before analyzing.
            </div>
            
            <!-- No Keyword Warning (shown/hidden by JS) -->
            <div id="seo-no-keyword-warning" style="display: none; padding: 0.75rem; background: #fff3cd; border-radius: 6px; margin-bottom: 1rem; color: #856404; font-size: 0.9rem;">
                ‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞.
            </div>
            
            <!-- Loading State -->
            <div id="seo-report-loading" style="display: none; text-align: center; padding: 2rem;">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚è≥</div>
                <p style="color: #666;">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç—å—é –¥–ª—è SEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏...</p>
                <p style="color: #999; font-size: 0.85rem;">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 15-30 —Å–µ–∫—É–Ω–¥</p>
            </div>
            
            <!-- Report Display -->
            <div id="seo-report-result" style="display: none;">
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #e8f5e9; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                    <span id="seo-report-timestamp" style="color: #2e7d32; font-size: 0.85rem;"></span>
                    <span id="seo-report-model" style="color: #666; font-size: 0.8rem;"></span>
                </div>
                <div id="seo-report-html" class="seo-report-content" style="line-height: 1.7; font-size: 0.95rem;"></div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end; flex-wrap: wrap;">
        <button id="btn-save-draft" style="padding: 0.75rem 1.5rem; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; color: var(--text-color);">
            Save Draft
        </button>
        <button id="btn-publish" style="padding: 0.75rem 1.5rem; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            {% if post.published %}Update{% else %}Publish{% endif %}
        </button>
    </div>
    
    <!-- Status Message -->
    <div id="status-message" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
    
    <!-- Image Edit Modal -->
    <div id="image-edit-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin: 0 0 1.5rem; font-size: 1.1rem; color: #333;">üì∑ Edit Image</h3>
            
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Alt Text (for accessibility & SEO)</label>
                <input type="text" id="img-alt" placeholder="Describe the image for screen readers..."
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                <small style="color: #666;">Appears if image fails to load. Read by screen readers.</small>
            </div>
            
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Title (tooltip on hover)</label>
                <input type="text" id="img-title" placeholder="Optional tooltip text..."
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <img id="img-preview" src="" alt="" style="max-width: 100%; max-height: 200px; border-radius: 6px; border: 1px solid #eee;">
            </div>
            
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                <button type="button" id="img-cancel" style="padding: 0.5rem 1rem; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; color: #333;">Cancel</button>
                <button type="button" id="img-save" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Button Insert Modal -->
    <div id="button-insert-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%;">
            <h3 style="margin: 0 0 1.5rem; font-size: 1.1rem; color: #333;">üîò Insert Button with Caption</h3>
            
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Button Text</label>
                <input type="text" id="btn-insert-text" placeholder="e.g., Read More, Buy Now..."
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
            </div>
            
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Button Link (URL)</label>
                <input type="url" id="btn-insert-link" placeholder="https://..."
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
            </div>
            
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Button Color</label>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button type="button" class="btn-color-option" data-color="#3b82f6" style="width: 36px; height: 36px; background: #3b82f6; border: 3px solid #3b82f6; border-radius: 6px; cursor: pointer;"></button>
                    <button type="button" class="btn-color-option" data-color="#22c55e" style="width: 36px; height: 36px; background: #22c55e; border: 3px solid transparent; border-radius: 6px; cursor: pointer;"></button>
                    <button type="button" class="btn-color-option" data-color="#ef4444" style="width: 36px; height: 36px; background: #ef4444; border: 3px solid transparent; border-radius: 6px; cursor: pointer;"></button>
                    <button type="button" class="btn-color-option" data-color="#f59e0b" style="width: 36px; height: 36px; background: #f59e0b; border: 3px solid transparent; border-radius: 6px; cursor: pointer;"></button>
                    <button type="button" class="btn-color-option" data-color="#8b5cf6" style="width: 36px; height: 36px; background: #8b5cf6; border: 3px solid transparent; border-radius: 6px; cursor: pointer;"></button>
                    <button type="button" class="btn-color-option" data-color="#333333" style="width: 36px; height: 36px; background: #333333; border: 3px solid transparent; border-radius: 6px; cursor: pointer;"></button>
                </div>
                <input type="hidden" id="btn-insert-color" value="#3b82f6">
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Caption Text (optional)</label>
                <input type="text" id="btn-insert-caption" placeholder="Text below the button..."
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
            </div>
            
            <!-- Preview -->
            <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <label style="display: block; font-weight: 600; margin-bottom: 1rem; color: #666; font-size: 0.85rem;">Preview</label>
                <a id="btn-preview" href="#" style="display: inline-block; padding: 12px 24px; background-color: #3b82f6; color: #ffffff !important; text-decoration: none !important; border-radius: 8px; font-weight: 600; font-size: 16px; border: none; cursor: pointer;">Button Text</a>
                <p id="btn-preview-caption" style="margin: 0.75rem 0 0; color: #666; font-size: 0.9rem;"></p>
            </div>
            
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                <button type="button" id="btn-insert-cancel" style="padding: 0.5rem 1rem; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; color: #333;">Cancel</button>
                <button type="button" id="btn-insert-confirm" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Insert</button>
            </div>
        </div>
    </div>
</section>

<!-- Quill CSS -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">

<!-- Quill JS -->
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Quill
    // Custom table picker handler
    var tableModule = Quill.import('modules/table');
    
    var quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Start writing your story...',
        modules: {
            table: true,
            toolbar: {
                container: [
                    [{ 'header': [2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['blockquote', 'code-block'],
                    ['link', 'image'],
                    ['insertTable', 'insertButton'],
                    ['clean']
                ],
                handlers: {
                    'insertTable': function() {
                        showTablePicker();
                    },
                    'insertButton': function() {
                        showButtonModal();
                    },
                    'image': function() {
                        // Create hidden file input
                        var input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        input.setAttribute('accept', 'image/*');
                        input.click();
                        
                        input.onchange = function() {
                            var file = input.files[0];
                            if (file) {
                                uploadImage(file);
                            }
                        };
                    }
                }
            }
        }
    });
    
    // Create table picker UI
    var tablePickerEl = document.createElement('div');
    tablePickerEl.id = 'table-picker';
    tablePickerEl.innerHTML = `
        <div class="table-picker-header">Insert Table</div>
        <div class="table-picker-grid" id="table-grid"></div>
        <div class="table-picker-size" id="table-size">0 √ó 0</div>
        <div class="table-picker-buttons">
            <button type="button" onclick="insertTableRow()">+ Row</button>
            <button type="button" onclick="insertTableCol()">+ Col</button>
            <button type="button" onclick="deleteTableRow()">- Row</button>
            <button type="button" onclick="deleteTableCol()">- Col</button>
        </div>
        <div class="table-picker-header" style="margin-top: 10px;">Cell Alignment</div>
        <div class="table-picker-buttons">
            <button type="button" onclick="alignTableCell('left')" title="Align Left">‚¨Ö</button>
            <button type="button" onclick="alignTableCell('center')" title="Align Center">‚Üî</button>
            <button type="button" onclick="alignTableCell('right')" title="Align Right">‚û°</button>
        </div>
    `;
    tablePickerEl.style.cssText = 'display: none; position: absolute; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 10px; z-index: 1000;';
    document.body.appendChild(tablePickerEl);
    
    // Build the grid (8x8)
    var gridEl = document.getElementById('table-grid');
    gridEl.style.cssText = 'display: grid; grid-template-columns: repeat(8, 20px); gap: 2px;';
    for (var r = 0; r < 8; r++) {
        for (var c = 0; c < 8; c++) {
            var cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.dataset.row = r;
            cell.dataset.col = c;
            cell.style.cssText = 'width: 20px; height: 20px; border: 1px solid #ddd; background: white; cursor: pointer;';
            cell.addEventListener('mouseenter', highlightCells);
            cell.addEventListener('click', insertTable);
            gridEl.appendChild(cell);
        }
    }
    
    function highlightCells(e) {
        var row = parseInt(e.target.dataset.row);
        var col = parseInt(e.target.dataset.col);
        var cells = gridEl.querySelectorAll('.grid-cell');
        cells.forEach(function(cell) {
            var cr = parseInt(cell.dataset.row);
            var cc = parseInt(cell.dataset.col);
            cell.style.background = (cr <= row && cc <= col) ? '#3b82f6' : 'white';
        });
        document.getElementById('table-size').textContent = (row + 1) + ' √ó ' + (col + 1);
    }
    
    function insertTable(e) {
        var rows = parseInt(e.target.dataset.row) + 1;
        var cols = parseInt(e.target.dataset.col) + 1;
        var table = quill.getModule('table');
        if (table) {
            quill.focus();
            table.insertTable(rows, cols);
        }
        hideTablePicker();
    }
    
    function showTablePicker() {
        var toolbar = document.querySelector('.ql-toolbar');
        var btn = toolbar.querySelector('.ql-insertTable');
        var rect = btn.getBoundingClientRect();
        tablePickerEl.style.display = 'block';
        tablePickerEl.style.top = (rect.bottom + window.scrollY + 5) + 'px';
        tablePickerEl.style.left = (rect.left + window.scrollX) + 'px';
    }
    
    function hideTablePicker() {
        tablePickerEl.style.display = 'none';
    }
    
    // Close picker when clicking outside
    document.addEventListener('click', function(e) {
        if (!tablePickerEl.contains(e.target) && !e.target.classList.contains('ql-insertTable')) {
            hideTablePicker();
        }
    });
    
    // Table editing functions
    window.insertTableRow = function() {
        var table = quill.getModule('table');
        if (table) table.insertRowBelow();
    };
    window.insertTableCol = function() {
        var table = quill.getModule('table');
        if (table) table.insertColumnRight();
    };
    window.deleteTableRow = function() {
        var table = quill.getModule('table');
        if (table) table.deleteRow();
    };
    window.deleteTableCol = function() {
        var table = quill.getModule('table');
        if (table) table.deleteColumn();
    };
    
    // Cell alignment function
    window.alignTableCell = function(alignment) {
        var selection = quill.getSelection();
        if (!selection) return;
        
        // Find the TD element at current cursor
        var node = quill.root;
        var range = document.createRange();
        try {
            var [leaf] = quill.getLeaf(selection.index);
            if (leaf && leaf.domNode) {
                var td = leaf.domNode.closest('td');
                if (td) {
                    td.style.textAlign = alignment;
                }
            }
        } catch (e) {
            console.log('Alignment failed:', e);
        }
    };
    
    // Style the custom toolbar button
    var style = document.createElement('style');
    style.textContent = `
        .ql-insertTable::before { content: '‚äû'; font-size: 18px; }
        .ql-insertButton::before { content: 'üîò'; font-size: 16px; }
        .table-picker-header { font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #333; }
        .table-picker-size { text-align: center; margin-top: 8px; font-size: 0.85rem; color: #666; }
        .table-picker-buttons { display: flex; gap: 4px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .table-picker-buttons button { flex: 1; padding: 4px 8px; font-size: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5; cursor: pointer; }
        .table-picker-buttons button:hover { background: #e5e5e5; }
    `;
    document.head.appendChild(style);
    
    // Handle image paste
    quill.root.addEventListener('paste', function(e) {
        var items = e.clipboardData && e.clipboardData.items;
        if (!items) return;
        
        for (var i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                e.preventDefault();
                var file = items[i].getAsFile();
                uploadImage(file);
                break;
            }
        }
    });
    
    function uploadImage(file) {
        var formData = new FormData();
        formData.append('image', file);
        
        fetch('{% url "blog_upload_image" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                var range = quill.getSelection(true);
                quill.insertEmbed(range.index, 'image', data.url);
            } else {
                showStatus('Failed to upload image', 'error');
            }
        })
        .catch(function() {
            showStatus('Failed to upload image', 'error');
        });
    }
    
    // Save functions
    function savePost(publish) {
        var title = document.getElementById('post-title').value.trim();
        if (!title) {
            showStatus('Please enter a title', 'error');
            return;
        }
        
        // Use publish parameter if true (Publish button), otherwise use status dropdown
        var isPublished = publish || document.getElementById('post-status').value === 'published';
        var content_html = quill.root.innerHTML;
        
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                title: title,
                content_html: content_html,
                published: isPublished,
                slug: document.getElementById('post-slug').value.trim(),
                featured_image: document.getElementById('featured-image-url').value,
                excerpt: document.getElementById('post-excerpt').value,
                meta_title: document.getElementById('meta-title').value,
                meta_description: document.getElementById('meta-description').value,
                og_image: document.getElementById('og-image').value
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                // Update status dropdown to reflect saved state
                document.getElementById('post-status').value = isPublished ? 'published' : 'draft';
                showStatus(isPublished ? 'Post published!' : 'Draft saved!', 'success');
                if (!window.location.pathname.includes('/edit/')) {
                    window.history.replaceState({}, '', '/blog/edit/' + data.slug + '/');
                }
                // Update slug field with saved value
                document.getElementById('post-slug').value = data.slug;
            } else {
                showStatus('Failed to save post', 'error');
            }
        })
        .catch(function() {
            showStatus('Failed to save post', 'error');
        });
    }
    
    document.getElementById('btn-save-draft').addEventListener('click', function() { savePost(false); });
    document.getElementById('btn-publish').addEventListener('click', function() { savePost(true); });
    
    function showStatus(message, type) {
        var el = document.getElementById('status-message');
        el.textContent = message;
        el.style.display = 'block';
        el.style.background = type === 'error' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 197, 94, 0.2)';
        el.style.color = type === 'error' ? '#ef4444' : '#22c55e';
        setTimeout(function() { el.style.display = 'none'; }, 3000);
    }
    
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Autosave functionality
    var lastContent = quill.root.innerHTML;
    var lastTitle = document.getElementById('post-title').value;
    var autosaveTimer = null;
    var hasChanges = false;
    
    function checkForChanges() {
        var currentContent = quill.root.innerHTML;
        var currentTitle = document.getElementById('post-title').value;
        if (currentContent !== lastContent || currentTitle !== lastTitle) {
            hasChanges = true;
            lastContent = currentContent;
            lastTitle = currentTitle;
        }
    }
    
    function autosave() {
        var title = document.getElementById('post-title').value.trim();
        if (!title || !hasChanges) return;
        
        var content_html = quill.root.innerHTML;
        
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                title: title,
                content_html: content_html,
                published: {{ post.published|yesno:"true,false,false" }},
                slug: document.getElementById('post-slug').value.trim(),
                featured_image: document.getElementById('featured-image-url').value,
                excerpt: document.getElementById('post-excerpt').value,
                meta_title: document.getElementById('meta-title').value,
                meta_description: document.getElementById('meta-description').value,
                og_image: document.getElementById('og-image').value
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                hasChanges = false;
                showStatus('Autosaved', 'success');
                if (!window.location.pathname.includes('/edit/')) {
                    window.history.replaceState({}, '', '/blog/edit/' + data.slug + '/');
                }
                document.getElementById('post-slug').value = data.slug;
            }
        })
        .catch(function() {});
    }
    
    // Check for changes every 5 seconds, autosave every 30 seconds if changes detected
    setInterval(checkForChanges, 5000);
    setInterval(autosave, 30000);
    
    // Post Options Panel Toggle
    document.getElementById('post-options-toggle').addEventListener('click', function() {
        var content = document.getElementById('post-options-content');
        var arrow = document.getElementById('post-options-arrow');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            arrow.textContent = '‚ñ≤';
        } else {
            content.style.display = 'none';
            arrow.textContent = '‚ñº';
        }
    });
    
    // Auto-generate excerpt from post content
    document.getElementById('auto-excerpt').addEventListener('click', function() {
        var html = quill.root.innerHTML;
        var text = html.replace(/<[^>]+>/g, '').trim();
        var excerpt = text.substring(0, 200);
        if (text.length > 200) excerpt += '...';
        document.getElementById('post-excerpt').value = excerpt;
        hasChanges = true;
        showStatus('Excerpt generated from post', 'success');
    });
    
    // Featured Image Handling
    var featuredImageUrl = document.getElementById('featured-image-url');
    var featuredImagePreview = document.getElementById('featured-image-preview');
    var featuredImageImg = document.getElementById('featured-image-img');
    
    function updateFeaturedPreview(url) {
        if (url) {
            featuredImageImg.src = url;
            featuredImagePreview.style.display = 'block';
        } else {
            featuredImagePreview.style.display = 'none';
        }
        hasChanges = true;
    }
    
    featuredImageUrl.addEventListener('input', function() {
        updateFeaturedPreview(this.value);
    });
    
    // Clear featured image
    document.getElementById('clear-featured').addEventListener('click', function() {
        featuredImageUrl.value = '';
        updateFeaturedPreview('');
    });
    
    // Upload new featured image
    document.getElementById('upload-featured').addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        
        var formData = new FormData();
        formData.append('image', file);
        
        fetch('{% url "blog_upload_image" %}', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                featuredImageUrl.value = data.url;
                updateFeaturedPreview(data.url);
                showStatus('Featured image uploaded', 'success');
            }
        });
    });
    
    // Select from post images
    document.getElementById('select-from-post').addEventListener('click', function() {
        var grid = document.getElementById('post-images-grid');
        var container = document.getElementById('post-images-container');
        
        if (grid.style.display === 'flex') {
            grid.style.display = 'none';
            return;
        }
        
        // Find all images in the editor
        var images = quill.root.querySelectorAll('img');
        container.innerHTML = '';
        
        if (images.length === 0) {
            container.innerHTML = '<p style="color: #888;">No images found in post.</p>';
        } else {
            images.forEach(function(img) {
                var thumb = document.createElement('img');
                thumb.src = img.src;
                thumb.style.cssText = 'width: 80px; height: 53px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 2px solid transparent;';
                thumb.addEventListener('click', function() {
                    featuredImageUrl.value = img.src;
                    updateFeaturedPreview(img.src);
                    grid.style.display = 'none';
                    showStatus('Featured image selected', 'success');
                });
                thumb.addEventListener('mouseenter', function() { this.style.borderColor = '#3b82f6'; });
                thumb.addEventListener('mouseleave', function() { this.style.borderColor = 'transparent'; });
                container.appendChild(thumb);
            });
        }
        
        grid.style.display = 'flex';
    });
    
    // SEO Panel Toggle
    document.getElementById('seo-toggle').addEventListener('click', function() {
        var content = document.getElementById('seo-content');
        var arrow = document.getElementById('seo-arrow');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            arrow.textContent = '‚ñ≤';
        } else {
            content.style.display = 'none';
            arrow.textContent = '‚ñº';
        }
    });
    
    // Character counters
    function updateCounter(inputId, counterId, max) {
        var input = document.getElementById(inputId);
        var counter = document.getElementById(counterId);
        function update() {
            var len = input.value.length;
            counter.textContent = '(' + len + '/' + max + ')';
            counter.style.color = len > max ? '#ef4444' : '#666';
        }
        input.addEventListener('input', update);
        update();
    }
    
    updateCounter('meta-title', 'meta-title-count', 60);
    updateCounter('meta-description', 'meta-desc-count', 160);
    updateCounter('post-excerpt', 'excerpt-count', 300);
    
    // Live Google preview update
    function updatePreview() {
        var title = document.getElementById('meta-title').value || document.getElementById('post-title').value || 'Post Title';
        var slug = document.getElementById('post-slug').value || 'your-post';
        var desc = document.getElementById('meta-description').value || 'Your meta description will appear here...';
        
        document.getElementById('preview-title').textContent = title;
        document.getElementById('preview-slug').textContent = slug;
        document.getElementById('preview-desc').textContent = desc;
    }
    
    document.getElementById('meta-title').addEventListener('input', updatePreview);
    document.getElementById('post-title').addEventListener('input', updatePreview);
    document.getElementById('post-slug').addEventListener('input', updatePreview);
    document.getElementById('meta-description').addEventListener('input', updatePreview);
    
    updatePreview();
    
    // Image click-to-edit functionality
    var currentEditingImage = null;
    var modal = document.getElementById('image-edit-modal');
    
    // Listen for clicks on images in the editor
    quill.root.addEventListener('click', function(e) {
        if (e.target.tagName === 'IMG') {
            currentEditingImage = e.target;
            document.getElementById('img-alt').value = e.target.alt || '';
            document.getElementById('img-title').value = e.target.title || '';
            document.getElementById('img-preview').src = e.target.src;
            modal.style.display = 'flex';
        }
    });
    
    // Cancel button
    document.getElementById('img-cancel').addEventListener('click', function() {
        modal.style.display = 'none';
        currentEditingImage = null;
    });
    
    // Click outside modal to close
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
            currentEditingImage = null;
        }
    });
    
    // Save button
    document.getElementById('img-save').addEventListener('click', function() {
        if (currentEditingImage) {
            currentEditingImage.alt = document.getElementById('img-alt').value;
            currentEditingImage.title = document.getElementById('img-title').value;
            hasChanges = true;
            showStatus('Image attributes saved', 'success');
        }
        modal.style.display = 'none';
        currentEditingImage = null;
    });
    
    // SEO Report Panel Toggle
    var seoReportToggle = document.getElementById('seo-report-toggle');
    if (seoReportToggle) {
        seoReportToggle.addEventListener('click', function() {
            var content = document.getElementById('seo-report-content');
            var arrow = document.getElementById('seo-report-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                arrow.textContent = '‚ñº';
            }
        });
    }
    
    // SEO Report Functions
    function fetchSeoReport(refresh) {
        var slug = document.getElementById('post-slug').value;
        var warningEl = document.getElementById('seo-no-slug-warning');
        var keywordWarningEl = document.getElementById('seo-no-keyword-warning');
        
        // Check for slug
        if (!slug) {
            if (warningEl) warningEl.style.display = 'block';
            if (keywordWarningEl) keywordWarningEl.style.display = 'none';
            showStatus('–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å—Ç–∞—Ç—å—é —Å–Ω–∞—á–∞–ª–∞', 'error');
            return;
        }
        if (warningEl) warningEl.style.display = 'none';
        
        // Check for main keyword
        var mainKeyword = document.getElementById('seo-main-keyword').value.trim();
        if (!mainKeyword) {
            if (keywordWarningEl) keywordWarningEl.style.display = 'block';
            showStatus('–í–≤–µ–¥–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ', 'error');
            return;
        }
        if (keywordWarningEl) keywordWarningEl.style.display = 'none';
        
        var lsiKeywords = document.getElementById('seo-lsi-keywords').value.trim();
        
        var loadingEl = document.getElementById('seo-report-loading');
        var resultEl = document.getElementById('seo-report-result');
        var analyzeBtn = document.getElementById('btn-analyze-seo');
        var reanalyzeBtn = document.getElementById('btn-reanalyze-seo');
        var modelSelect = document.getElementById('seo-model-select');
        var selectedModel = modelSelect ? modelSelect.value : 'gemini-2.0-flash';
        
        // Collect post content with structure preserved
        var postTitle = document.getElementById('post-title').value;
        var postContent = quill.root.innerHTML;
        
        // Collect SEO settings
        var metaTitle = document.getElementById('meta-title').value;
        var metaDescription = document.getElementById('meta-description').value;
        var postExcerpt = document.getElementById('post-excerpt').value;
        
        // Show loading
        loadingEl.style.display = 'block';
        resultEl.style.display = 'none';
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...';
        if (reanalyzeBtn) {
            reanalyzeBtn.disabled = true;
        }
        
        var url = '/blog/api/seo-report/' + slug + '/';
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                model: selectedModel,
                refresh: refresh,
                main_keyword: mainKeyword,
                lsi_keywords: lsiKeywords,
                post_title: postTitle,
                post_content: postContent,
                meta_title: metaTitle,
                meta_description: metaDescription,
                excerpt: postExcerpt
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            loadingEl.style.display = 'none';
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'üîç Analyze SEO';
            if (reanalyzeBtn) {
                reanalyzeBtn.disabled = false;
            }
            
            if (data.success) {
                // Display result
                document.getElementById('seo-report-html').innerHTML = data.html_content;
                document.getElementById('seo-report-timestamp').textContent = '–°–æ–∑–¥–∞–Ω–æ: ' + data.created_at;
                document.getElementById('seo-report-model').textContent = '–ú–æ–¥–µ–ª—å: ' + data.model;
                resultEl.style.display = 'block';
                
                // Show re-analyze button, hide analyze button
                analyzeBtn.style.display = 'none';
                if (reanalyzeBtn) {
                    reanalyzeBtn.style.display = 'inline-block';
                }
                
                showStatus('SEO-–æ—Ç—á—ë—Ç –≥–æ—Ç–æ–≤!', 'success');
            } else {
                showStatus('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        })
        .catch(function(err) {
            loadingEl.style.display = 'none';
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'üîç Analyze SEO';
            if (reanalyzeBtn) {
                reanalyzeBtn.disabled = false;
            }
            showStatus('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞', 'error');
            console.error(err);
        });
    }
    
    // Analyze SEO button
    var analyzeSeoBtn = document.getElementById('btn-analyze-seo');
    if (analyzeSeoBtn) {
        analyzeSeoBtn.addEventListener('click', function() {
            fetchSeoReport(false);
        });
    }
    
    // Re-analyze SEO button
    var reanalyzeSeoBtn = document.getElementById('btn-reanalyze-seo');
    if (reanalyzeSeoBtn) {
        reanalyzeSeoBtn.addEventListener('click', function() {
            fetchSeoReport(true);
        });
    }
    
    // Load cached SEO report on page load
    function loadCachedSeoReport() {
        var slug = document.getElementById('post-slug').value;
        if (!slug) return;
        
        var resultEl = document.getElementById('seo-report-result');
        var analyzeBtn = document.getElementById('btn-analyze-seo');
        var reanalyzeBtn = document.getElementById('btn-reanalyze-seo');
        
        fetch('/blog/api/seo-report/' + slug + '/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success && data.html_content) {
                // Display cached result
                document.getElementById('seo-report-html').innerHTML = data.html_content;
                document.getElementById('seo-report-timestamp').textContent = '–°–æ–∑–¥–∞–Ω–æ: ' + data.created_at;
                document.getElementById('seo-report-model').textContent = '–ú–æ–¥–µ–ª—å: ' + data.model;
                resultEl.style.display = 'block';
                
                // Show re-analyze button, hide analyze button
                if (analyzeBtn) analyzeBtn.style.display = 'none';
                if (reanalyzeBtn) reanalyzeBtn.style.display = 'inline-block';
            }
        })
        .catch(function(err) {
            // Silently fail - no cached report available
            console.log('No cached SEO report found');
        });
    }
    
    // Load cached report when page loads
    loadCachedSeoReport();
    
    // Button Insert Modal
    var buttonModal = document.getElementById('button-insert-modal');
    var btnInsertText = document.getElementById('btn-insert-text');
    var btnInsertLink = document.getElementById('btn-insert-link');
    var btnInsertCaption = document.getElementById('btn-insert-caption');
    var btnInsertColor = document.getElementById('btn-insert-color');
    var btnPreview = document.getElementById('btn-preview');
    var btnPreviewCaption = document.getElementById('btn-preview-caption');
    var savedSelection = null;
    
    function showButtonModal() {
        // Save the current cursor position
        savedSelection = quill.getSelection();
        
        // Clear/reset fields
        btnInsertText.value = '';
        btnInsertLink.value = '';
        btnInsertCaption.value = '';
        btnInsertColor.value = '#3b82f6';
        btnPreview.textContent = 'Button Text';
        btnPreview.style.backgroundColor = '#3b82f6';
        btnPreviewCaption.textContent = '';
        
        // Reset color picker selection
        document.querySelectorAll('.btn-color-option').forEach(function(btn) {
            btn.style.borderColor = btn.dataset.color === '#3b82f6' ? '#3b82f6' : 'transparent';
        });
        
        buttonModal.style.display = 'flex';
        btnInsertText.focus();
    }
    
    function hideButtonModal() {
        buttonModal.style.display = 'none';
    }
    
    // Color picker
    document.querySelectorAll('.btn-color-option').forEach(function(colorBtn) {
        colorBtn.addEventListener('click', function() {
            var color = this.dataset.color;
            btnInsertColor.value = color;
            btnPreview.style.backgroundColor = color;
            
            // Update selection visual
            document.querySelectorAll('.btn-color-option').forEach(function(btn) {
                btn.style.borderColor = 'transparent';
            });
            this.style.borderColor = color;
        });
    });
    
    // Update preview on input
    btnInsertText.addEventListener('input', function() {
        btnPreview.textContent = this.value || 'Button Text';
    });
    
    btnInsertCaption.addEventListener('input', function() {
        btnPreviewCaption.textContent = this.value;
    });
    
    // Cancel button
    document.getElementById('btn-insert-cancel').addEventListener('click', hideButtonModal);
    
    // Click outside to close
    buttonModal.addEventListener('click', function(e) {
        if (e.target === buttonModal) {
            hideButtonModal();
        }
    });
    
    // Insert button
    document.getElementById('btn-insert-confirm').addEventListener('click', function() {
        var text = btnInsertText.value.trim();
        var link = btnInsertLink.value.trim();
        var caption = btnInsertCaption.value.trim();
        var color = btnInsertColor.value;
        
        if (!text) {
            showStatus('Please enter button text', 'error');
            return;
        }
        
        if (!link) {
            showStatus('Please enter button link', 'error');
            return;
        }
        
        // Build the HTML for the centered button with caption
        var buttonHtml = '<div style="text-align: center; margin: 2rem 0;">';
        buttonHtml += '<a href="' + link + '" target="_blank" rel="noopener" style="display: inline-block; padding: 12px 28px; background-color: ' + color + '; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">' + text + '</a>';
        if (caption) {
            buttonHtml += '<p style="margin: 0.75rem 0 0; color: #888; font-size: 0.9rem;">' + caption + '</p>';
        }
        buttonHtml += '</div>';
        
        // Restore selection and insert
        if (savedSelection) {
            quill.setSelection(savedSelection.index, 0);
        }
        
        // Use clipboard to paste HTML
        var range = quill.getSelection(true);
        quill.clipboard.dangerouslyPasteHTML(range.index, buttonHtml);
        
        hideButtonModal();
        hasChanges = true;
        showStatus('Button inserted', 'success');
    });
});
</script>

<style>
/* Quill Toolbar - Fixed positioning */
.ql-toolbar.ql-snow {
    background: #f8f9fa !important;
    border: none !important;
    border-bottom: 1px solid #e0e0e0 !important;
    position: fixed !important;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    padding: 12px 20px !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.ql-toolbar.ql-snow .ql-stroke {
    stroke: #333 !important;
}
.ql-toolbar.ql-snow .ql-fill {
    fill: #333 !important;
}
.ql-toolbar.ql-snow .ql-picker {
    color: #333 !important;
}
.ql-toolbar.ql-snow button:hover .ql-stroke {
    stroke: #3b82f6 !important;
}
.ql-toolbar.ql-snow button:hover .ql-fill {
    fill: #3b82f6 !important;
}
.ql-container.ql-snow {
    border: none;
    font-size: 1rem;
    font-family: inherit;
}
.ql-editor {
    min-height: 500px;
    color: var(--text-color);
    padding: 1.5rem;
}
.ql-editor.ql-blank::before {
    color: var(--secondary-text);
    font-style: normal;
}
/* Match published post styling */
.ql-editor p {
    margin-bottom: 1.5rem;
    font-size: 1.05rem;
    line-height: 1.6;
}
.ql-snow .ql-stroke {
    stroke: var(--text-color);
}
.ql-snow .ql-fill {
    fill: var(--text-color);
}
.ql-snow .ql-picker {
    color: var(--text-color);
}
.ql-snow .ql-picker-options {
    background: #f8f9fa;
}
.ql-editor h2 {
    font-size: 1.5rem;
    font-family: 'Roboto Mono', monospace;
    font-weight: 700;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
}
.ql-editor h3 {
    font-size: 1.25rem;
    font-family: 'Roboto Mono', monospace;
    font-weight: 700;
    margin-top: 2rem;
    margin-bottom: 1rem;
}
.ql-editor blockquote {
    border-left: 3px solid #ccc;
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: #555;
    font-style: italic;
}
.ql-editor pre.ql-syntax {
    background: #f5f5f5;
    color: #333;
    padding: 1rem;
    border-radius: 4px;
    font-family: 'Roboto Mono', monospace;
    font-size: 0.9rem;
    margin: 1.5rem 0;
    overflow-x: auto;
}
.ql-editor code {
    font-family: 'Roboto Mono', monospace;
    background: #f5f5f5;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-size: 0.9em;
}
.ql-editor img {
    max-width: 100%;
    height: auto;
    margin: 2rem 0;
    border: 1px solid #eee;
    cursor: pointer;
    transition: outline 0.2s ease;
}
.ql-editor img:hover {
    outline: 3px solid #3b82f6;
    outline-offset: 2px;
}
.ql-editor a {
    color: #000;
    text-decoration: underline;
}
.ql-editor ul, .ql-editor ol {
    margin-bottom: 1.5rem;
    padding-left: 1.2rem;
}
.ql-editor li {
    margin-bottom: 0.5rem;
}
/* SEO Report Content Styling */
.seo-report-content h2 {
    font-size: 1.15rem;
    font-weight: 700;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: #333;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 0.5rem;
}
.seo-report-content h2:first-child {
    margin-top: 0;
}
.seo-report-content ul, .seo-report-content ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
}
.seo-report-content li {
    margin-bottom: 0.4rem;
}
.seo-report-content p {
    margin-bottom: 0.75rem;
}
.seo-report-content strong {
    color: #1a1a1a;
}
.seo-report-content code {
    background: #f0f0f0;
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-size: 0.9em;
}
</style>
{% endblock %}
